"""
–ú–æ–¥—É–ª—å –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞.
–°–æ–¥–µ—Ä–∂–∏—Ç –æ—Ç–¥–µ–ª—å–Ω—ã–µ –≤–∏–¥–∂–µ—Ç—ã –∏ –ø–∞–Ω–µ–ª–∏ –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
"""

from typing import Callable, Optional
from PySide6.QtWidgets import (
    QWidget, QVBoxLayout, QHBoxLayout, QTextEdit, QLabel, QSpinBox, 
    QDoubleSpinBox, QPushButton, QFileDialog, QGroupBox, QComboBox,
    QTabWidget, QFormLayout, QFontComboBox, QLineEdit, QProgressBar,
    QTextBrowser, QGridLayout, QCheckBox, QRadioButton, QButtonGroup,
    QMessageBox
)
from PySide6.QtCore import Qt, Signal
from PySide6.QtGui import QFont

from config import PageSettings, TextSettings, PageNumberSettings


class EditorPanel(QGroupBox):
    """–ü–∞–Ω–µ–ª—å —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ —Ç–µ–∫—Å—Ç–∞"""
    
    text_changed = Signal(str)
    
    def __init__(self):
        super().__init__("üìù –£–º–Ω—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä")
        self.setup_ui()
        
    def setup_ui(self):
        """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞"""
        layout = QVBoxLayout(self)
        
        # –†–µ–¥–∞–∫—Ç–æ—Ä —Ç–µ–∫—Å—Ç–∞
        self.text_editor = QTextEdit()
        self.text_editor.setPlaceholderText(
            "–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç –∫–æ–Ω—Å–ø–µ–∫—Ç–∞...\n\n"
            "‚ú® –£–º–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:\n"
            "‚Ä¢ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ –ø–æ —Å–µ—Ç–∫–µ\n"
            "‚Ä¢ –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π —Ä–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞\n"
            "‚Ä¢ –£–º–Ω—ã–π –ø–µ—Ä–µ–Ω–æ—Å —Å—Ç—Ä–æ–∫\n"
            "‚Ä¢ –ö—Ä–∞—Å–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ –∏ –æ—Ç—Å—Ç—É–ø—ã\n"
            "‚Ä¢ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω—É–º–µ—Ä–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü\n\n"
            "üìù –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:\n"
            "‚Ä¢ **–∂–∏—Ä–Ω—ã–π** *–∫—É—Ä—Å–∏–≤*\n"
            "‚Ä¢ LaTeX: $x^2 + y^2 = z^2$\n"
            "‚Ä¢ –ì—Ä–µ—á–µ—Å–∫–∏–µ: $\\alpha, \\beta, \\pi$\n"
        )
        self.text_editor.textChanged.connect(self._on_text_changed)
        self.text_editor.setMinimumHeight(500)
        layout.addWidget(self.text_editor)
        
        # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–µ–∫—Å—Ç–µ
        self.info_group = self.create_text_info_widget()
        layout.addWidget(self.info_group)
    
    def create_text_info_widget(self) -> QGroupBox:
        """–°–æ–∑–¥–∞–Ω–∏–µ –≤–∏–¥–∂–µ—Ç–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Ç–µ–∫—Å—Ç–∞"""
        info_group = QGroupBox("üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞")
        info_layout = QGridLayout(info_group)
        
        self.chars_label = QLabel("–°–∏–º–≤–æ–ª–æ–≤: 0")
        self.words_label = QLabel("–°–ª–æ–≤: 0")
        self.lines_label = QLabel("–°—Ç—Ä–æ–∫: 0")
        self.pages_label = QLabel("–°—Ç—Ä–∞–Ω–∏—Ü: 0")
        
        info_layout.addWidget(self.chars_label, 0, 0)
        info_layout.addWidget(self.words_label, 0, 1)
        info_layout.addWidget(self.lines_label, 1, 0)
        info_layout.addWidget(self.pages_label, 1, 1)
        
        return info_group
    
    def _on_text_changed(self):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞"""
        text = self.text_editor.toPlainText()
        self.update_statistics(text)
        self.text_changed.emit(text)
    
    def update_statistics(self, text: str):
        """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏"""
        char_count = len(text)
        word_count = len([w for w in text.split() if w.strip()])
        line_count = len(text.split('\n'))
        
        self.chars_label.setText(f"–°–∏–º–≤–æ–ª–æ–≤: {char_count}")
        self.words_label.setText(f"–°–ª–æ–≤: {word_count}")
        self.lines_label.setText(f"–°—Ç—Ä–æ–∫: {line_count}")
    
    def update_page_count(self, page_count: int):
        """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å—Ç—Ä–∞–Ω–∏—Ü"""
        self.pages_label.setText(f"–°—Ç—Ä–∞–Ω–∏—Ü: {page_count}")
    
    def get_text(self) -> str:
        """–ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞"""
        return self.text_editor.toPlainText()
    
    def set_text(self, text: str):
        """–£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–µ–∫—Å—Ç–∞"""
        self.text_editor.setPlainText(text)


class PageSettingsTab(QWidget):
    """–í–∫–ª–∞–¥–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã"""
    
    settings_changed = Signal()
    
    def __init__(self, settings: PageSettings):
        super().__init__()
        self.settings = settings
        self.setup_ui()
        
    def setup_ui(self):
        """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞"""
        layout = QVBoxLayout(self)
        
        # –†–∞–∑–º–µ—Ä—ã
        size_group = QGroupBox("üìè –†–∞–∑–º–µ—Ä—ã –ª–∏—Å—Ç–∞")
        size_layout = QFormLayout(size_group)
        
        self.width_spinbox = QDoubleSpinBox()
        self.width_spinbox.setRange(10.0, 500.0)
        self.width_spinbox.setValue(self.settings.width_mm)
        self.width_spinbox.setSuffix(" –º–º")
        self.width_spinbox.valueChanged.connect(self.on_settings_changed)
        
        self.height_spinbox = QDoubleSpinBox()
        self.height_spinbox.setRange(10.0, 500.0)
        self.height_spinbox.setValue(self.settings.height_mm)
        self.height_spinbox.setSuffix(" –º–º")
        self.height_spinbox.valueChanged.connect(self.on_settings_changed)
        
        size_layout.addRow("–®–∏—Ä–∏–Ω–∞:", self.width_spinbox)
        size_layout.addRow("–í—ã—Å–æ—Ç–∞:", self.height_spinbox)
        
        # –ü–æ–ª—è
        margins_group = QGroupBox("üìê –ü–æ–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã")
        margins_layout = QFormLayout(margins_group)
        
        self.margin_left_spinbox = QDoubleSpinBox()
        self.margin_left_spinbox.setRange(0.0, 50.0)
        self.margin_left_spinbox.setValue(self.settings.margin_left_mm)
        self.margin_left_spinbox.setSuffix(" –º–º")
        self.margin_left_spinbox.valueChanged.connect(self.on_settings_changed)
        
        self.margin_right_spinbox = QDoubleSpinBox()
        self.margin_right_spinbox.setRange(0.0, 50.0)
        self.margin_right_spinbox.setValue(self.settings.margin_right_mm)
        self.margin_right_spinbox.setSuffix(" –º–º")
        self.margin_right_spinbox.valueChanged.connect(self.on_settings_changed)
        
        self.margin_top_spinbox = QDoubleSpinBox()
        self.margin_top_spinbox.setRange(0.0, 50.0)
        self.margin_top_spinbox.setValue(self.settings.margin_top_mm)
        self.margin_top_spinbox.setSuffix(" –º–º")
        self.margin_top_spinbox.valueChanged.connect(self.on_settings_changed)
        
        self.margin_bottom_spinbox = QDoubleSpinBox()
        self.margin_bottom_spinbox.setRange(0.0, 50.0)
        self.margin_bottom_spinbox.setValue(self.settings.margin_bottom_mm)
        self.margin_bottom_spinbox.setSuffix(" –º–º")
        self.margin_bottom_spinbox.valueChanged.connect(self.on_settings_changed)
        
        margins_layout.addRow("–°–ª–µ–≤–∞:", self.margin_left_spinbox)
        margins_layout.addRow("–°–ø—Ä–∞–≤–∞:", self.margin_right_spinbox)
        margins_layout.addRow("–°–≤–µ—Ä—Ö—É:", self.margin_top_spinbox)
        margins_layout.addRow("–°–Ω–∏–∑—É:", self.margin_bottom_spinbox)
        
        # –°–µ—Ç–∫–∞
        grid_group = QGroupBox("‚äû –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ—Ç–∫–∏")
        grid_layout = QFormLayout(grid_group)
        
        self.grid_type_combo = QComboBox()
        self.grid_type_combo.addItems(["–∫–ª–µ—Ç–∫–∞", "–ª–∏–Ω–µ–π–∫–∞"])
        self.grid_type_combo.setCurrentText(self.settings.grid_type)
        self.grid_type_combo.currentTextChanged.connect(self.on_settings_changed)
        
        self.grid_size_spinbox = QDoubleSpinBox()
        self.grid_size_spinbox.setRange(0.5, 20.0)
        self.grid_size_spinbox.setValue(self.settings.grid_size_mm)
        self.grid_size_spinbox.setSuffix(" –º–º")
        self.grid_size_spinbox.valueChanged.connect(self.on_settings_changed)
        
        self.dpi_spinbox = QSpinBox()
        self.dpi_spinbox.setRange(72, 600)
        self.dpi_spinbox.setValue(self.settings.dpi)
        self.dpi_spinbox.setSuffix(" dpi")
        self.dpi_spinbox.valueChanged.connect(self.on_settings_changed)
        
        grid_layout.addRow("–¢–∏–ø —Å–µ—Ç–∫–∏:", self.grid_type_combo)
        grid_layout.addRow("–†–∞–∑–º–µ—Ä –∫–ª–µ—Ç–∫–∏:", self.grid_size_spinbox)
        grid_layout.addRow("–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ:", self.dpi_spinbox)
        
        layout.addWidget(size_group)
        layout.addWidget(margins_group)
        layout.addWidget(grid_group)
        layout.addStretch()
    
    def on_settings_changed(self):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫"""
        self.update_settings()
        self.settings_changed.emit()
    
    def update_settings(self):
        """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏–∑ –≤–∏–¥–∂–µ—Ç–æ–≤"""
        self.settings.width_mm = self.width_spinbox.value()
        self.settings.height_mm = self.height_spinbox.value()
        self.settings.margin_left_mm = self.margin_left_spinbox.value()
        self.settings.margin_right_mm = self.margin_right_spinbox.value()
        self.settings.margin_top_mm = self.margin_top_spinbox.value()
        self.settings.margin_bottom_mm = self.margin_bottom_spinbox.value()
        self.settings.grid_type = self.grid_type_combo.currentText()
        self.settings.grid_size_mm = self.grid_size_spinbox.value()
        self.settings.dpi = self.dpi_spinbox.value()


class TextSettingsTab(QWidget):
    """–í–∫–ª–∞–¥–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Ç–µ–∫—Å—Ç–∞"""
    
    settings_changed = Signal()
    
    def __init__(self, settings: TextSettings):
        super().__init__()
        self.settings = settings
        self.setup_ui()
        
    def setup_ui(self):
        """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞"""
        layout = QVBoxLayout(self)
        
        # –®—Ä–∏—Ñ—Ç
        font_group = QGroupBox("üî§ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —à—Ä–∏—Ñ—Ç–∞")
        font_layout = QFormLayout(font_group)
        
        self.font_combo = QFontComboBox()
        self.font_combo.setCurrentFont(QFont(self.settings.font_family))
        self.font_combo.currentFontChanged.connect(self.on_settings_changed)
        
        self.font_size_spinbox = QDoubleSpinBox()
        self.font_size_spinbox.setRange(6.0, 72.0)
        self.font_size_spinbox.setValue(self.settings.font_size_pt)
        self.font_size_spinbox.setSuffix(" pt")
        self.font_size_spinbox.valueChanged.connect(self.on_settings_changed)
        
        font_layout.addRow("–®—Ä–∏—Ñ—Ç:", self.font_combo)
        font_layout.addRow("–†–∞–∑–º–µ—Ä:", self.font_size_spinbox)
        
        # –ò–Ω—Ç–µ—Ä–≤–∞–ª—ã
        spacing_group = QGroupBox("üìê –ò–Ω—Ç–µ—Ä–≤–∞–ª—ã")
        spacing_layout = QFormLayout(spacing_group)
        
        self.line_spacing_spinbox = QDoubleSpinBox()
        self.line_spacing_spinbox.setRange(0.5, 5.0)
        self.line_spacing_spinbox.setValue(self.settings.line_spacing)
        self.line_spacing_spinbox.setSingleStep(0.1)
        self.line_spacing_spinbox.valueChanged.connect(self.on_settings_changed)
        
        self.letter_spacing_spinbox = QDoubleSpinBox()
        self.letter_spacing_spinbox.setRange(0.0, 10.0)
        self.letter_spacing_spinbox.setValue(self.settings.letter_spacing_mm)
        self.letter_spacing_spinbox.setSuffix(" –º–º")
        self.letter_spacing_spinbox.valueChanged.connect(self.on_settings_changed)
        
        self.paragraph_spacing_spinbox = QDoubleSpinBox()
        self.paragraph_spacing_spinbox.setRange(0.0, 20.0)
        self.paragraph_spacing_spinbox.setValue(self.settings.paragraph_spacing_mm)
        self.paragraph_spacing_spinbox.setSuffix(" –º–º")
        self.paragraph_spacing_spinbox.valueChanged.connect(self.on_settings_changed)
        
        spacing_layout.addRow("–ú–µ–∂—Å—Ç—Ä–æ—á–Ω—ã–π:", self.line_spacing_spinbox)
        spacing_layout.addRow("–ú–µ–∂–¥—É –±—É–∫–≤–∞–º–∏:", self.letter_spacing_spinbox)
        spacing_layout.addRow("–ú–µ–∂–¥—É –∞–±–∑–∞—Ü–∞–º–∏:", self.paragraph_spacing_spinbox)
        
        # –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ
        alignment_group = QGroupBox("üìç –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ")
        alignment_layout = QFormLayout(alignment_group)
        
        self.alignment_combo = QComboBox()
        self.alignment_combo.addItems(["left", "center", "right", "justify"])
        self.alignment_combo.setCurrentText(self.settings.alignment)
        self.alignment_combo.currentTextChanged.connect(self.on_settings_changed)
        
        self.indent_spinbox = QDoubleSpinBox()
        self.indent_spinbox.setRange(0.0, 20.0)
        self.indent_spinbox.setValue(self.settings.indent_first_line_mm)
        self.indent_spinbox.setSuffix(" –º–º")
        self.indent_spinbox.valueChanged.connect(self.on_settings_changed)
        
        alignment_layout.addRow("–í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ:", self.alignment_combo)
        alignment_layout.addRow("–ö—Ä–∞—Å–Ω–∞—è —Å—Ç—Ä–æ–∫–∞:", self.indent_spinbox)
        
        layout.addWidget(font_group)
        layout.addWidget(spacing_group)
        layout.addWidget(alignment_group)
        layout.addStretch()
    
    def on_settings_changed(self):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫"""
        self.update_settings()
        self.settings_changed.emit()
    
    def update_settings(self):
        """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏–∑ –≤–∏–¥–∂–µ—Ç–æ–≤"""
        self.settings.font_family = self.font_combo.currentFont().family()
        self.settings.font_size_pt = self.font_size_spinbox.value()
        self.settings.line_spacing = self.line_spacing_spinbox.value()
        self.settings.letter_spacing_mm = self.letter_spacing_spinbox.value()
        self.settings.paragraph_spacing_mm = self.paragraph_spacing_spinbox.value()
        self.settings.alignment = self.alignment_combo.currentText()
        self.settings.indent_first_line_mm = self.indent_spinbox.value()


class SmartFormattingTab(QWidget):
    """–í–∫–ª–∞–¥–∫–∞ —É–º–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è"""
    
    settings_changed = Signal()
    info_updated = Signal(str)
    
    def __init__(self, text_settings: TextSettings, page_number_settings: PageNumberSettings):
        super().__init__()
        self.text_settings = text_settings
        self.page_number_settings = page_number_settings
        self.setup_ui()
        
    def setup_ui(self):
        """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞"""
        layout = QVBoxLayout(self)
        
        # –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π —à—Ä–∏—Ñ—Ç
        adaptive_group = QGroupBox("üß† –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π —à—Ä–∏—Ñ—Ç")
        adaptive_layout = QFormLayout(adaptive_group)
        
        self.auto_font_checkbox = QCheckBox("–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞–∑–º–µ—Ä –ø–æ–¥ —Å–µ—Ç–∫—É")
        self.auto_font_checkbox.setChecked(self.text_settings.auto_font_size)
        self.auto_font_checkbox.toggled.connect(self.on_settings_changed)
        
        self.font_fill_ratio_spinbox = QDoubleSpinBox()
        self.font_fill_ratio_spinbox.setRange(0.1, 1.0)
        self.font_fill_ratio_spinbox.setValue(self.text_settings.font_fill_ratio)
        self.font_fill_ratio_spinbox.setSingleStep(0.1)
        self.font_fill_ratio_spinbox.valueChanged.connect(self.on_settings_changed)
        
        adaptive_layout.addRow(self.auto_font_checkbox)
        adaptive_layout.addRow("–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è:", self.font_fill_ratio_spinbox)
        
        # –ù—É–º–µ—Ä–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü
        page_num_group = QGroupBox("üìÑ –ù—É–º–µ—Ä–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü")
        page_num_layout = QFormLayout(page_num_group)
        
        self.page_numbers_checkbox = QCheckBox("–í–∫–ª—é—á–∏—Ç—å –Ω—É–º–µ—Ä–∞—Ü–∏—é")
        self.page_numbers_checkbox.setChecked(self.page_number_settings.enabled)
        self.page_numbers_checkbox.toggled.connect(self.on_settings_changed)
        
        self.page_position_combo = QComboBox()
        positions = ["bottom_center", "bottom_left", "bottom_right", 
                    "top_center", "top_left", "top_right"]
        self.page_position_combo.addItems(positions)
        self.page_position_combo.setCurrentText(self.page_number_settings.position)
        self.page_position_combo.currentTextChanged.connect(self.on_settings_changed)
        
        self.page_format_line = QLineEdit()
        self.page_format_line.setText(self.page_number_settings.format)
        self.page_format_line.setPlaceholderText("–ù–∞–ø—Ä–∏–º–µ—Ä: - {page} - –∏–ª–∏ —Å—Ç—Ä. {page} –∏–∑ {total}")
        self.page_format_line.textChanged.connect(self.on_settings_changed)
        
        self.page_font_size_spinbox = QDoubleSpinBox()
        self.page_font_size_spinbox.setRange(6.0, 24.0)
        self.page_font_size_spinbox.setValue(self.page_number_settings.font_size_pt)
        self.page_font_size_spinbox.setSuffix(" pt")
        self.page_font_size_spinbox.valueChanged.connect(self.on_settings_changed)
        
        page_num_layout.addRow(self.page_numbers_checkbox)
        page_num_layout.addRow("–ü–æ–∑–∏—Ü–∏—è:", self.page_position_combo)
        page_num_layout.addRow("–§–æ—Ä–º–∞—Ç:", self.page_format_line)
        page_num_layout.addRow("–†–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞:", self.page_font_size_spinbox)
        
        # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
        info_group = QGroupBox("‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è")
        info_layout = QVBoxLayout(info_group)
        
        self.adaptive_font_info = QLabel()
        info_layout.addWidget(self.adaptive_font_info)
        
        layout.addWidget(adaptive_group)
        layout.addWidget(page_num_group)
        layout.addWidget(info_group)
        layout.addStretch()
    
    def on_settings_changed(self):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫"""
        self.update_settings()
        self.settings_changed.emit()
    
    def update_settings(self):
        """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏–∑ –≤–∏–¥–∂–µ—Ç–æ–≤"""
        self.text_settings.auto_font_size = self.auto_font_checkbox.isChecked()
        self.text_settings.font_fill_ratio = self.font_fill_ratio_spinbox.value()
        
        self.page_number_settings.enabled = self.page_numbers_checkbox.isChecked()
        self.page_number_settings.position = self.page_position_combo.currentText()
        self.page_number_settings.format = self.page_format_line.text()
        self.page_number_settings.font_size_pt = self.page_font_size_spinbox.value()
    
    def update_info(self, info_text: str):
        """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞"""
        self.adaptive_font_info.setText(info_text)


class ExportTab(QWidget):
    """–í–∫–ª–∞–¥–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞"""
    
    export_gcode_requested = Signal()
    export_image_requested = Signal()
    export_all_pages_requested = Signal()
    
    def __init__(self):
        super().__init__()
        self.setup_ui()
        
    def setup_ui(self):
        """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞"""
        layout = QVBoxLayout(self)
        
        # –ü—Ä–æ–≥—Ä–µ—Å—Å
        progress_group = QGroupBox("‚öôÔ∏è –ü—Ä–æ—Ü–µ—Å—Å —ç–∫—Å–ø–æ—Ä—Ç–∞")
        progress_layout = QVBoxLayout(progress_group)
        
        self.export_progress = QProgressBar()
        self.export_progress.setVisible(False)
        progress_layout.addWidget(self.export_progress)
        
        self.export_status_label = QLabel("–ì–æ—Ç–æ–≤ –∫ —ç–∫—Å–ø–æ—Ä—Ç—É")
        progress_layout.addWidget(self.export_status_label)
        
        # –ö–Ω–æ–ø–∫–∏ —ç–∫—Å–ø–æ—Ä—Ç–∞
        buttons_layout = QVBoxLayout()
        
        export_gcode_btn = QPushButton("üì§ –≠–∫—Å–ø–æ—Ä—Ç —É–º–Ω–æ–≥–æ G-code")
        export_gcode_btn.clicked.connect(self.export_gcode_requested.emit)
        export_gcode_btn.setMinimumHeight(40)
        
        export_image_btn = QPushButton("üñºÔ∏è –≠–∫—Å–ø–æ—Ä—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è")
        export_image_btn.clicked.connect(self.export_image_requested.emit)
        
        export_all_pages_btn = QPushButton("üìö –≠–∫—Å–ø–æ—Ä—Ç –≤—Å–µ—Ö —Å—Ç—Ä–∞–Ω–∏—Ü")
        export_all_pages_btn.clicked.connect(self.export_all_pages_requested.emit)
        
        buttons_layout.addWidget(export_gcode_btn)
        buttons_layout.addWidget(export_image_btn)
        buttons_layout.addWidget(export_all_pages_btn)
        
        # –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä G-code
        preview_group = QGroupBox("üëÄ –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä G-code")
        preview_layout = QVBoxLayout(preview_group)
        
        self.gcode_preview = QTextBrowser()
        self.gcode_preview.setMaximumHeight(200)
        self.gcode_preview.setPlaceholderText("–£–º–Ω—ã–π G-code –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω –∑–¥–µ—Å—å...")
        preview_layout.addWidget(self.gcode_preview)
        
        layout.addWidget(progress_group)
        layout.addLayout(buttons_layout)
        layout.addWidget(preview_group)
        layout.addStretch()
    
    def show_progress(self, show: bool):
        """–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å"""
        self.export_progress.setVisible(show)
    
    def set_progress(self, value: int):
        """–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞"""
        self.export_progress.setValue(value)
    
    def set_status(self, status: str):
        """–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å —ç–∫—Å–ø–æ—Ä—Ç–∞"""
        self.export_status_label.setText(status)
    
    def set_gcode_preview(self, gcode: str):
        """–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä G-code"""
        self.gcode_preview.setPlainText(gcode)


class NavigationWidget(QWidget):
    """–í–∏–¥–∂–µ—Ç –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º"""
    
    prev_page = Signal()
    next_page = Signal()
    
    def __init__(self):
        super().__init__()
        self.setup_ui()
        
    def setup_ui(self):
        """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞"""
        layout = QHBoxLayout(self)
        
        self.prev_page_btn = QPushButton("‚óÄ –ü—Ä–µ–¥—ã–¥—É—â–∞—è")
        self.prev_page_btn.clicked.connect(self.prev_page.emit)
        
        self.page_info_label = QLabel("–°—Ç—Ä–∞–Ω–∏—Ü–∞ 1 –∏–∑ 1")
        self.page_info_label.setAlignment(Qt.AlignCenter)
        
        self.next_page_btn = QPushButton("–°–ª–µ–¥—É—é—â–∞—è ‚ñ∂")
        self.next_page_btn.clicked.connect(self.next_page.emit)
        
        layout.addWidget(self.prev_page_btn)
        layout.addWidget(self.page_info_label)
        layout.addWidget(self.next_page_btn)
    
    def update_navigation(self, current_page: int, total_pages: int):
        """–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏"""
        self.page_info_label.setText(f"–°—Ç—Ä–∞–Ω–∏—Ü–∞ {current_page + 1} –∏–∑ {total_pages}")
        self.prev_page_btn.setEnabled(current_page > 0)
        self.next_page_btn.setEnabled(current_page < total_pages - 1)


class BackgroundControlWidget(QWidget):
    """–í–∏–¥–∂–µ—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ñ–æ–Ω–æ–º"""
    
    generate_grid = Signal()
    import_background = Signal()
    clear_background = Signal()
    
    def __init__(self):
        super().__init__()
        self.setup_ui()
        
    def setup_ui(self):
        """–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞"""
        layout = QHBoxLayout(self)
        
        generate_grid_btn = QPushButton("üé® –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–µ—Ç–∫—É")
        generate_grid_btn.clicked.connect(self.generate_grid.emit)
        
        import_bg_btn = QPushButton("üìÅ –ò–º–ø–æ—Ä—Ç —Ñ–æ–Ω–∞")
        import_bg_btn.clicked.connect(self.import_background.emit)
        
        clear_bg_btn = QPushButton("üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å —Ñ–æ–Ω")
        clear_bg_btn.clicked.connect(self.clear_background.emit)
        
        layout.addWidget(generate_grid_btn)
        layout.addWidget(import_bg_btn)
        layout.addWidget(clear_bg_btn)


def show_error_message(parent: QWidget, title: str, message: str):
    """–ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ"""
    QMessageBox.critical(parent, title, message)


def show_info_message(parent: QWidget, title: str, message: str):
    """–ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ"""
    QMessageBox.information(parent, title, message)


def show_warning_message(parent: QWidget, title: str, message: str):
    """–ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ"""
    QMessageBox.warning(parent, title, message)


def get_save_file_name(parent: QWidget, title: str, default_name: str, filter: str) -> Optional[str]:
    """–î–∏–∞–ª–æ–≥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–∞"""
    file_path, _ = QFileDialog.getSaveFileName(parent, title, default_name, filter)
    return file_path if file_path else None


def get_open_file_name(parent: QWidget, title: str, filter: str) -> Optional[str]:
    """–î–∏–∞–ª–æ–≥ –æ—Ç–∫—Ä—ã—Ç–∏—è —Ñ–∞–π–ª–∞"""
    file_path, _ = QFileDialog.getOpenFileName(parent, title, "", filter)
    return file_path if file_path else None


def get_directory(parent: QWidget, title: str) -> Optional[str]:
    """–î–∏–∞–ª–æ–≥ –≤—ã–±–æ—Ä–∞ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏"""
    dir_path = QFileDialog.getExistingDirectory(parent, title)
    return dir_path if dir_path else None
